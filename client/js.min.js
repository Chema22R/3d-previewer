"use strict";function controller3D(){function e(){requestAnimationFrame(e),a.render(o,n)}function t(e,t){if("stl"===t.type){if(t.vertices.length>0&&e.addAttribute("position",new THREE.BufferAttribute(new Float32Array(t.vertices),3)),t.normals.length>0){for(var o=[],n=0;n<t.normals.length;n+=3)o.push(t.normals[n],t.normals[n+1],t.normals[n+2]),o.push(t.normals[n],t.normals[n+1],t.normals[n+2]),o.push(t.normals[n],t.normals[n+1],t.normals[n+2]);e.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(o),3))}}else"ply"===t.type?(t.indices.length>0&&e.setIndex(t.indices),t.vertices.length>0&&e.addAttribute("position",new THREE.Float32BufferAttribute(t.vertices,3)),t.normals.length>0&&e.addAttribute("normal",new THREE.Float32BufferAttribute(t.normals,3)),e.computeBoundingSphere()):"obj"===t.type&&(t.vertices.length>0&&e.addAttribute("position",new THREE.Float32BufferAttribute(t.vertices,3)),t.normals.length>0&&e.addAttribute("normal",new THREE.Float32BufferAttribute(t.normals,3)));return e}var o,n,r,a,i,s,l,c,p,u,h,d=$(".previewControl.wrapper"),f=new CP(document.querySelector(".palette.icon")).set("#aaaaaa");this.init=function(){o=new THREE.Scene,n=new THREE.PerspectiveCamera(75,d.width()/d.height(),1,1e3),n.position.set(0,0,100),o.add(n),r=new THREE.HemisphereLight(16777215,0,1),n.add(r),a=new THREE.WebGLRenderer({canvas:$("canvas.previewControl").get(0),antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(d.width(),d.height()),a.setClearColor(2105376),i=new THREE.OrbitControls(n,a.domElement),s=new THREE.MeshPhongMaterial({color:11184810,shading:THREE.FlatShading,wireframe:!1}),l=new THREE.MeshBasicMaterial({color:11184810,shading:THREE.SmoothShading,wireframe:!0,wireframeLinewidth:1}),c=new THREE.Box3,e()},this.loadMesh=function(e){if(u?(o.remove(u),f.set("#aaaaaa"),s.color.setHex("0xaaaaaa"),l.color.setHex("0xaaaaaa")):$(".navbar.right").fadeIn("slow"),i.reset(),p=t(new THREE.BufferGeometry,e),p.center(),u=new THREE.Mesh(p,s),h=c.setFromObject(u).getSize(),h.x<100&&h.y<100&&h.z<100||h.x>100||h.y>100||h.z>100){var n=h.x;n<h.y&&(n=h.y),n<h.z&&(n=h.z),u.scale.multiplyScalar(100/n)}o.add(u)},$(window).resize(function(){n.aspect=d.width()/d.height(),n.updateProjectionMatrix(),a.setSize(d.width(),d.height())}),$(".navbar.right .reset.icon").click(function(e){e.preventDefault(),u.rotation.x=0,u.rotation.y=0,u.rotation.z=0,i.reset()}),$(".rotatorArrows *").click(function(e){e.preventDefault();var t=new THREE.Matrix4;switch($(this).attr("class").split(" ")[0]){case"icon-arrow-up":t.makeRotationAxis(new THREE.Vector3(1,0,0).normalize(),Math.PI/2);break;case"icon-arrow-down":t.makeRotationAxis(new THREE.Vector3(1,0,0).normalize(),-Math.PI/2);break;case"icon-arrow-right":t.makeRotationAxis(new THREE.Vector3(0,1,0).normalize(),-Math.PI/2);break;case"icon-arrow-left":t.makeRotationAxis(new THREE.Vector3(0,1,0).normalize(),Math.PI/2)}u.matrix=t.multiply(u.matrix),u.rotation.setFromRotationMatrix(u.matrix)}),$(".navbar.right .wireframe.icon").click(function(e){e.preventDefault(),u.material.uuid===s.uuid?u.material=l:u.material=s}),f.on("change",function(e){u&&(s.color.setHex("0x"+e),l.color.setHex("0x"+e))})}var controller3D;$(function(){controller3D=new controller3D,controller3D.init()}),$(function(){function e(e){if(0==e.length)$(".fileList.entries").css("padding","30px").text("No hay elementos para mostrar");else{$(".fileList.entries").css("padding","0px");for(var o=0;o<e.length;o++)$("<div class='"+e[o]._id+" fileList entry'><div class='"+e[o]._id+" fileList info pointer' title='"+e[o].name+"'><p class='fileList name'>"+e[o].name+"</p><p class='fileList date'>"+new Date(e[o].date).toLocaleString()+"</p></div><span class='"+e[o]._id+" fileList icon-delete pointer' title='delete "+e[o].name+"'></span></div>").appendTo(".fileList.entries")}$(".fileList.menu").fadeIn("slow"),setTimeout(function(){$(".fileList.menu").scrollTop(0),t()},10)}function t(){$(".fileList.menu .fileList.info").click(function(e){e.preventDefault();var t=$(this).attr("class").split(" ")[0],n=this.parentNode.parentNode;$(".loadingBar.wrapper").fadeIn("slow"),$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file/"+t,method:"GET",success:function(e,t){$(".loadingBar.wrapper").fadeOut("slow"),$(".fileList.menu").fadeOut("slow",function(){for(;n.childNodes.length>0;)n.childNodes[0].remove();$(".fileList.menu .fileList.search").val("")}),controller3D.loadMesh(e)},error:function(e,t,n){$(".loadingBar.wrapper").fadeOut("slow"),o(n?e.responseText:"Unable to connect to server","red")}})}),$(".fileList.menu .fileList.icon-delete").click(function(e){e.preventDefault();var t=$(this).attr("class").split(" ")[0],n=this.parentNode;$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file/"+t,method:"DELETE",success:function(e,t){$(n).hide(400,"linear",function(){n.remove()})},error:function(e,t,n){o(n?e.responseText:"Unable to connect to server","red")}})})}function o(e,t){$(".stateMessage").text(e).css({color:"white",background:t}).fadeIn("slow",function(){setTimeout(function(){$(".stateMessage").fadeOut("slow")},2e3)})}$(".navbar.top .fileList.icon").click(function(t){t.preventDefault(),$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file",method:"GET",success:function(t,o){e(t)},error:function(e,t,n){o(n?e.responseText:"Unable to connect to server","red")}})}),$(window).on("mousedown touchstart",function(e){if(!$(e.target).is(".fileList")&&"none"!=$(".fileList.menu").css("display")){var t=$(".fileList.entries")[0];$(".fileList.menu").fadeOut("slow",function(){for(;t.childNodes.length>0;)t.childNodes[0].remove();$(".fileList.menu .fileList.search").val("")})}}),$(".fileList.menu .fileList.search").on("input propertychange change",function(e){e.preventDefault();var t=$(this).val().toLowerCase().trim();$(".fileList.name").html(function(e,o){o.toLowerCase().includes(t)?$(this).parent().parent().show():$(this).parent().parent().hide()}),$(".fileList.date").html(function(e,o){o.toLowerCase().includes(t)&&$(this).parent().parent().show()})})}),$(function(){function e(e){var t=["stl","ply","obj"];for(let o=0;o<t.length;o++)if(t[o]==e.toLowerCase())return!0;return!1}function t(e,t){$(".stateMessage").text(e).css({color:"white",background:t}).fadeIn("slow",function(){setTimeout(function(){$(".stateMessage").fadeOut("slow")},2e3)})}$(".navbar.top input[type='file'].fileUpload").change(function(o){o.preventDefault();var n=$(this).get(0).files[0];if(e(n.name.substring(n.name.lastIndexOf(".")+1))){var r=new FormData;r.append("file",n),$(".loadingBar.wrapper").fadeIn("slow"),$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file",method:"POST",data:r,processData:!1,contentType:!1,success:function(e,o){$(".loadingBar.wrapper").fadeOut("slow"),t("File uploaded successfully","green"),controller3D.loadMesh(e)},error:function(e,o,n){$(".loadingBar.wrapper").fadeOut("slow"),t(n?e.responseText:"Unable to connect to server","red")}})}else t("Extension not supported. You can use stl, ply, obj","red")})}),$(function(){$(window).resize(function(){$(".help.wrapper .help.menu").css("left",(window.innerWidth-$(".help.wrapper .help.menu").innerWidth())/2)}),$(window).on("orientationchange",function(){setTimeout(function(){$(".help.wrapper .help.menu").css("left",(window.innerWidth-$(".help.wrapper .help.menu").innerWidth())/2)},500)}),$(".navbar.right .help.icon").click(function(e){e.preventDefault(),$(".help.wrapper").fadeIn("slow"),$(".help.wrapper .help.menu").css("left",(window.innerWidth-$(".help.wrapper .help.menu").innerWidth())/2),setTimeout(function(){$(".help.content").scrollTop(0),$(".help.content").scrollLeft(0)},10)}),$(".help.wrapper .help.leftover, .help.wrapper .help.menu .exitButton").on("mousedown touchstart",function(e){e.preventDefault(),$(".help.wrapper").fadeOut("slow")})}),THREE.OrbitControls=function(e,t){function o(e){e.preventDefault()}function n(e){e.preventDefault(),e.button===u.mouseControls.ROTATE?(g.set(e.clientX,e.clientY),d=h.ROTATE):e.button===u.mouseControls.ZOOM?(w.set(e.clientX,e.clientY),d=h.ZOOM):e.button===u.mouseControls.PAN&&(b.set(e.clientX,e.clientY),d=h.PAN),d!==h.NONE&&(document.addEventListener("mousemove",r,!1),document.addEventListener("mouseup",a,!1))}function r(e){e.preventDefault(),d===h.ROTATE?(O.set(e.clientX,e.clientY),R.subVectors(O,g),m.theta-=2*Math.PI*R.x/t.clientWidth*u.rotateSpeed,m.phi-=2*Math.PI*R.y/t.clientHeight*u.rotateSpeed,g.copy(O)):d===h.ZOOM?(T.set(e.clientX,e.clientY),v.subVectors(T,w),v.y>0?E/=Math.pow(.95,u.zoomSpeed):v.y<0&&(E*=Math.pow(.95,u.zoomSpeed)),w.copy(T)):d===h.PAN&&(A.set(e.clientX,e.clientY),H.subVectors(A,b),M(H.x,H.y),b.copy(A)),u.update()}function a(e){document.removeEventListener("mousemove",r,!1),document.removeEventListener("mouseup",a,!1),d=h.NONE}function i(e){d!==h.NONE&&d!==h.ROTATE||(e.preventDefault(),e.stopPropagation(),e.deltaY<0?E*=Math.pow(.95,u.zoomSpeed):e.deltaY>0&&(E/=Math.pow(.95,u.zoomSpeed)),u.update())}function s(e){if(1===e.touches.length)g.set(e.touches[0].pageX,e.touches[0].pageY),d=h.TOUCH_ROTATE;else if(2===e.touches.length){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY;w.set(0,Math.sqrt(t*t+o*o)),d=h.TOUCH_ZOOM}else 3===e.touches.length?(b.set(e.touches[0].pageX,e.touches[0].pageY),d=h.TOUCH_PAN):d=h.NONE}function l(e){if(e.preventDefault(),e.stopPropagation(),1===e.touches.length&&d===h.TOUCH_ROTATE)O.set(e.touches[0].pageX,e.touches[0].pageY),R.subVectors(O,g),m.theta-=2*Math.PI*R.x/t.clientWidth*u.rotateSpeed,m.phi-=2*Math.PI*R.y/t.clientHeight*u.rotateSpeed,g.copy(O);else if(2===e.touches.length&&d===h.TOUCH_ZOOM){var o=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;T.set(0,Math.sqrt(o*o+n*n)),v.subVectors(T,w),v.y>0?E*=Math.pow(.95,u.zoomSpeed):v.y<0&&(E/=Math.pow(.95,u.zoomSpeed)),w.copy(T)}else 3===e.touches.length&&d===h.TOUCH_PAN?(A.set(e.touches[0].pageX,e.touches[0].pageY),H.subVectors(A,b),M(H.x,H.y),b.copy(A)):d=h.NONE;u.update()}function c(e){d=h.NONE}function p(e){switch(e.keyCode){case u.keyboardControls.ROTATEUP:m.phi-=u.rotateSpeed/4;break;case u.keyboardControls.ROTATEDOWN:m.phi+=u.rotateSpeed/4;break;case u.keyboardControls.ROTATELEFT:m.theta-=u.rotateSpeed/4;break;case u.keyboardControls.ROTATERIGHT:m.theta+=u.rotateSpeed/4;break;case u.keyboardControls.ZOOMIN:E*=Math.pow(.95,2*u.zoomSpeed);break;case u.keyboardControls.ZOOMOUT:E/=Math.pow(.95,2*u.zoomSpeed);break;case u.keyboardControls.PANUP:M(0,-u.panSpeed);break;case u.keyboardControls.PANDOWN:M(0,u.panSpeed);break;case u.keyboardControls.PANLEFT:M(-u.panSpeed,0);break;case u.keyboardControls.PANRIGHT:M(u.panSpeed,0)}u.update()}this.object=e,this.renderer=t,this.pivot=new THREE.Vector3,this.zoomMin=2,this.zoomMax=800,this.zoomSpeed=.5,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.rotateSpeed=1,this.panSpeed=7,this.mouseControls={ROTATE:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.keyboardControls={ZOOMIN:90,ZOOMOUT:88,PANLEFT:65,PANUP:87,PANRIGHT:68,PANDOWN:83,ROTATELEFT:37,ROTATEUP:38,ROTATERIGHT:39,ROTATEDOWN:40},this.pivotReset=this.pivot.clone(),this.positionReset=this.object.position.clone(),this.zoomReset=this.object.zoom,this.update=function(){var t=new THREE.Vector3,o=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),n=o.clone().inverse(),r=u.object.position;t.copy(r).sub(u.pivot),t.applyQuaternion(o),f.setFromVector3(t),f.theta+=m.theta,f.phi+=m.phi,f.theta=Math.max(u.minAzimuthAngle,Math.min(u.maxAzimuthAngle,f.theta)),f.phi=Math.max(u.minPolarAngle,Math.min(u.maxPolarAngle,f.phi)),f.makeSafe(),f.radius=Math.max(u.zoomMin,Math.min(u.zoomMax,f.radius*E)),u.pivot.add($),t.setFromSpherical(f),t.applyQuaternion(n),r.copy(u.pivot).add(t),u.object.lookAt(u.pivot),m.set(0,0,0),E=1,$.set(0,0,0)},this.reset=function(){u.pivot.copy(u.pivotReset),u.object.position.copy(u.positionReset),u.object.zoom=u.zoomReset,u.update(),d=h.NONE};var u=this,h={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},d=h.NONE,f=new THREE.Spherical,m=new THREE.Spherical,E=1,w=new THREE.Vector2,T=new THREE.Vector2,v=new THREE.Vector2,g=new THREE.Vector2,O=new THREE.Vector2,R=new THREE.Vector2,b=new THREE.Vector2,A=new THREE.Vector2,H=new THREE.Vector2,$=new THREE.Vector3,M=function(e,o){var n=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Vector3;n.copy(u.object.position).sub(u.pivot);var i=n.length();i*=Math.tan(u.object.fov/2*Math.PI/180),r.setFromMatrixColumn(u.object.matrix,0),a.setFromMatrixColumn(u.object.matrix,1),r.multiplyScalar(-2*e*i/t.clientHeight),a.multiplyScalar(2*o*i/t.clientHeight),$.add(r),$.add(a)};u.renderer.addEventListener("contextmenu",o,!1),u.renderer.addEventListener("mousedown",n,!1),u.renderer.addEventListener("wheel",i,!1),u.renderer.addEventListener("touchstart",s,!1),u.renderer.addEventListener("touchend",c,!1),u.renderer.addEventListener("touchmove",l,!1),window.addEventListener("keydown",p,!1),this.update()};var serverAddress="localhost",serverPort="8081";