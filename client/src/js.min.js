"use strict";function controller3D(){function e(){requestAnimationFrame(e),r.render(o,n)}function t(e,t){if("stl"===t.type){if(t.vertices.length>0&&e.addAttribute("position",new THREE.BufferAttribute(new Float32Array(t.vertices),3)),t.normals.length>0){for(var o=[],n=0;n<t.normals.length;n+=3)o.push(t.normals[n],t.normals[n+1],t.normals[n+2]),o.push(t.normals[n],t.normals[n+1],t.normals[n+2]),o.push(t.normals[n],t.normals[n+1],t.normals[n+2]);e.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(o),3))}}else"ply"===t.type?(t.indices.length>0&&e.setIndex(t.indices),t.vertices.length>0&&e.addAttribute("position",new THREE.Float32BufferAttribute(t.vertices,3)),t.normals.length>0&&e.addAttribute("normal",new THREE.Float32BufferAttribute(t.normals,3)),e.computeBoundingSphere()):"obj"===t.type&&(t.vertices.length>0&&e.addAttribute("position",new THREE.Float32BufferAttribute(t.vertices,3)),t.normals.length>0&&e.addAttribute("normal",new THREE.Float32BufferAttribute(t.normals,3)));return e}var o,n,a,r,i,s,l,c,u,d,p,h=$(".previewControl.wrapper"),m=new CP(document.querySelector(".palette.icon")).set("#aaaaaa");this.init=function(){o=new THREE.Scene,n=new THREE.PerspectiveCamera(75,h.width()/h.height(),1,1e3),n.position.set(0,0,100),o.add(n),a=new THREE.HemisphereLight(16777215,0,1),n.add(a),r=new THREE.WebGLRenderer({canvas:$("canvas.previewControl").get(0),antialias:!0}),r.setPixelRatio(window.devicePixelRatio),r.setSize(h.width(),h.height()),r.setClearColor(3158064),i=new THREE.OrbitControls(n,r.domElement),s=new THREE.MeshPhongMaterial({color:11184810,shading:THREE.FlatShading,wireframe:!1}),l=new THREE.MeshBasicMaterial({color:11184810,shading:THREE.SmoothShading,wireframe:!0,wireframeLinewidth:1}),c=new THREE.Box3,e()},this.loadMesh=function(e){if(d?(o.remove(d),m.set("#aaaaaa"),s.color.setHex("0xaaaaaa"),l.color.setHex("0xaaaaaa")):$(".navbar.right").fadeIn("slow"),i.reset(),u=t(new THREE.BufferGeometry,e),u.center(),d=new THREE.Mesh(u,s),p=c.setFromObject(d).getSize(),p.x<100&&p.y<100&&p.z<100||p.x>100||p.y>100||p.z>100){var n=p.x;n<p.y&&(n=p.y),n<p.z&&(n=p.z),d.scale.multiplyScalar(100/n)}o.add(d)},$(window).resize(function(){n.aspect=h.width()/h.height(),n.updateProjectionMatrix(),r.setSize(h.width(),h.height())}),$(".navbar.right .reset.icon").click(function(e){e.preventDefault(),d.rotation.x=0,d.rotation.y=0,d.rotation.z=0,i.reset()}),$(".rotatorArrows *").click(function(e){e.preventDefault();var t=new THREE.Matrix4;switch($(this).attr("class").split(" ")[0]){case"icon-arrow-up":t.makeRotationAxis(new THREE.Vector3(1,0,0).normalize(),Math.PI/2);break;case"icon-arrow-down":t.makeRotationAxis(new THREE.Vector3(1,0,0).normalize(),-Math.PI/2);break;case"icon-arrow-right":t.makeRotationAxis(new THREE.Vector3(0,1,0).normalize(),-Math.PI/2);break;case"icon-arrow-left":t.makeRotationAxis(new THREE.Vector3(0,1,0).normalize(),Math.PI/2)}d.matrix=t.multiply(d.matrix),d.rotation.setFromRotationMatrix(d.matrix)}),$(".navbar.right .wireframe.icon").click(function(e){e.preventDefault(),d.material.uuid===s.uuid?d.material=l:d.material=s}),m.on("change",function(e){d&&(s.color.setHex("0x"+e),l.color.setHex("0x"+e))})}function helpMenuFadeIn(){document.getElementById("helpMenu").style.display="flex",document.getElementById("helpMenuTextL").scrollTop=0,document.getElementById("helpMenuTextR").scrollTop=0,setTimeout(()=>{document.getElementById("helpMenu").style.opacity=1},50)}function helpMenuFadeOut(){document.getElementById("helpMenu").style.opacity=0,setTimeout(()=>{document.getElementById("helpMenu").style.display="none"},500)}var controller3D;$(function(){controller3D=new controller3D,controller3D.init()}),$(function(){function e(e){if(0==e.length)$(".fileList.entries").css("padding","30px").text("No hay elementos para mostrar");else{$(".fileList.entries").css("padding","0px");for(var o=0;o<e.length;o++)$("<div class='"+e[o]._id+" fileList entry'><div class='"+e[o]._id+" fileList info pointer' title='"+e[o].name+"'><p class='fileList name'>"+e[o].name+"</p><p class='fileList date'>"+new Date(e[o].date).toLocaleString()+"</p></div><span class='"+e[o]._id+" fileList icon-delete pointer' title='delete "+e[o].name+"'></span></div>").appendTo(".fileList.entries")}$(".fileList.menu").fadeIn("slow"),setTimeout(function(){$(".fileList.menu").scrollTop(0),t()},10)}function t(){$(".fileList.menu .fileList.info").click(function(e){e.preventDefault();var t=$(this).attr("class").split(" ")[0],n=this.parentNode.parentNode;$(".loadingBar.wrapper").fadeIn("slow"),$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file/"+t,method:"GET",success:function(e,t){$(".loadingBar.wrapper").fadeOut("slow"),$(".fileList.menu").fadeOut("slow",function(){for(;n.childNodes.length>0;)n.childNodes[0].remove();$(".fileList.menu .fileList.search").val("")}),controller3D.loadMesh(e)},error:function(e,t,n){$(".loadingBar.wrapper").fadeOut("slow"),o(n?e.responseText:"Unable to connect to server","red")}})}),$(".fileList.menu .fileList.icon-delete").click(function(e){e.preventDefault();var t=$(this).attr("class").split(" ")[0],n=this.parentNode;$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file/"+t,method:"DELETE",success:function(e,t){$(n).hide(400,"linear",function(){n.remove()})},error:function(e,t,n){o(n?e.responseText:"Unable to connect to server","red")}})})}function o(e,t){$(".stateMessage").text(e).css({color:"white",background:t}).fadeIn("slow",function(){setTimeout(function(){$(".stateMessage").fadeOut("slow")},2e3)})}$(".navbar.top .fileList.icon").click(function(t){t.preventDefault(),$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file",method:"GET",success:function(t,o){e(t)},error:function(e,t,n){o(n?e.responseText:"Unable to connect to server","red")}})}),$(window).on("mousedown touchstart",function(e){if(!$(e.target).is(".fileList")&&"none"!=$(".fileList.menu").css("display")){var t=$(".fileList.entries")[0];$(".fileList.menu").fadeOut("slow",function(){for(;t.childNodes.length>0;)t.childNodes[0].remove();$(".fileList.menu .fileList.search").val("")})}}),$(".fileList.menu .fileList.search").on("input propertychange change",function(e){e.preventDefault();var t=$(this).val().toLowerCase().trim();$(".fileList.name").html(function(e,o){o.toLowerCase().includes(t)?$(this).parent().parent().show():$(this).parent().parent().hide()}),$(".fileList.date").html(function(e,o){o.toLowerCase().includes(t)&&$(this).parent().parent().show()})})}),$(function(){function e(e){var t=["stl","ply","obj"];for(let o=0;o<t.length;o++)if(t[o]==e.toLowerCase())return!0;return!1}function t(e,t){$(".stateMessage").text(e).css({color:"white",background:t}).fadeIn("slow",function(){setTimeout(function(){$(".stateMessage").fadeOut("slow")},2e3)})}$(".navbar.top input[type='file'].fileUpload").change(function(o){o.preventDefault();var n=$(this).get(0).files[0];if(e(n.name.substring(n.name.lastIndexOf(".")+1))){var a=new FormData;a.append("file",n),$(".loadingBar.wrapper").fadeIn("slow"),$.ajax({url:"http://"+serverAddress+":"+serverPort+"/file",method:"POST",data:a,processData:!1,contentType:!1,success:function(e,o){$(".loadingBar.wrapper").fadeOut("slow"),t("File uploaded successfully","green"),controller3D.loadMesh(e)},error:function(e,o,n){$(".loadingBar.wrapper").fadeOut("slow"),t(n?e.responseText:"Unable to connect to server","red")}})}else t("Extension not supported. You can use stl, ply, obj","red")})}),THREE.OrbitControls=function(e,t){function o(e){e.preventDefault()}function n(e){e.preventDefault(),e.button===d.mouseControls.ROTATE?(g.set(e.clientX,e.clientY),h=p.ROTATE):e.button===d.mouseControls.ZOOM?(T.set(e.clientX,e.clientY),h=p.ZOOM):e.button===d.mouseControls.PAN&&(b.set(e.clientX,e.clientY),h=p.PAN),h!==p.NONE&&(document.addEventListener("mousemove",a,!1),document.addEventListener("mouseup",r,!1))}function a(e){e.preventDefault(),h===p.ROTATE?(R.set(e.clientX,e.clientY),O.subVectors(R,g),f.theta-=2*Math.PI*O.x/t.clientWidth*d.rotateSpeed,f.phi-=2*Math.PI*O.y/t.clientHeight*d.rotateSpeed,g.copy(R)):h===p.ZOOM?(w.set(e.clientX,e.clientY),v.subVectors(w,T),v.y>0?E/=Math.pow(.95,d.zoomSpeed):v.y<0&&(E*=Math.pow(.95,d.zoomSpeed)),T.copy(w)):h===p.PAN&&(y.set(e.clientX,e.clientY),M.subVectors(y,b),H(M.x,M.y),b.copy(y)),d.update()}function r(e){document.removeEventListener("mousemove",a,!1),document.removeEventListener("mouseup",r,!1),h=p.NONE}function i(e){h!==p.NONE&&h!==p.ROTATE||(e.preventDefault(),e.stopPropagation(),e.deltaY<0?E*=Math.pow(.95,d.zoomSpeed):e.deltaY>0&&(E/=Math.pow(.95,d.zoomSpeed)),d.update())}function s(e){if(1===e.touches.length)g.set(e.touches[0].pageX,e.touches[0].pageY),h=p.TOUCH_ROTATE;else if(2===e.touches.length){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY;T.set(0,Math.sqrt(t*t+o*o)),h=p.TOUCH_ZOOM}else 3===e.touches.length?(b.set(e.touches[0].pageX,e.touches[0].pageY),h=p.TOUCH_PAN):h=p.NONE}function l(e){if(e.preventDefault(),e.stopPropagation(),1===e.touches.length&&h===p.TOUCH_ROTATE)R.set(e.touches[0].pageX,e.touches[0].pageY),O.subVectors(R,g),f.theta-=2*Math.PI*O.x/t.clientWidth*d.rotateSpeed,f.phi-=2*Math.PI*O.y/t.clientHeight*d.rotateSpeed,g.copy(R);else if(2===e.touches.length&&h===p.TOUCH_ZOOM){var o=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;w.set(0,Math.sqrt(o*o+n*n)),v.subVectors(w,T),v.y>0?E*=Math.pow(.95,d.zoomSpeed):v.y<0&&(E/=Math.pow(.95,d.zoomSpeed)),T.copy(w)}else 3===e.touches.length&&h===p.TOUCH_PAN?(y.set(e.touches[0].pageX,e.touches[0].pageY),M.subVectors(y,b),H(M.x,M.y),b.copy(y)):h=p.NONE;d.update()}function c(e){h=p.NONE}function u(e){switch(e.keyCode){case d.keyboardControls.ROTATEUP:f.phi-=d.rotateSpeed/4;break;case d.keyboardControls.ROTATEDOWN:f.phi+=d.rotateSpeed/4;break;case d.keyboardControls.ROTATELEFT:f.theta-=d.rotateSpeed/4;break;case d.keyboardControls.ROTATERIGHT:f.theta+=d.rotateSpeed/4;break;case d.keyboardControls.ZOOMIN:E*=Math.pow(.95,2*d.zoomSpeed);break;case d.keyboardControls.ZOOMOUT:E/=Math.pow(.95,2*d.zoomSpeed);break;case d.keyboardControls.PANUP:H(0,-d.panSpeed);break;case d.keyboardControls.PANDOWN:H(0,d.panSpeed);break;case d.keyboardControls.PANLEFT:H(-d.panSpeed,0);break;case d.keyboardControls.PANRIGHT:H(d.panSpeed,0)}d.update()}this.object=e,this.renderer=t,this.pivot=new THREE.Vector3,this.zoomMin=2,this.zoomMax=800,this.zoomSpeed=.5,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.rotateSpeed=1,this.panSpeed=7,this.mouseControls={ROTATE:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.keyboardControls={ZOOMIN:90,ZOOMOUT:88,PANLEFT:65,PANUP:87,PANRIGHT:68,PANDOWN:83,ROTATELEFT:37,ROTATEUP:38,ROTATERIGHT:39,ROTATEDOWN:40},this.pivotReset=this.pivot.clone(),this.positionReset=this.object.position.clone(),this.zoomReset=this.object.zoom,this.update=function(){var t=new THREE.Vector3,o=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),n=o.clone().inverse(),a=d.object.position;t.copy(a).sub(d.pivot),t.applyQuaternion(o),m.setFromVector3(t),m.theta+=f.theta,m.phi+=f.phi,m.theta=Math.max(d.minAzimuthAngle,Math.min(d.maxAzimuthAngle,m.theta)),m.phi=Math.max(d.minPolarAngle,Math.min(d.maxPolarAngle,m.phi)),m.makeSafe(),m.radius=Math.max(d.zoomMin,Math.min(d.zoomMax,m.radius*E)),d.pivot.add(A),t.setFromSpherical(m),t.applyQuaternion(n),a.copy(d.pivot).add(t),d.object.lookAt(d.pivot),f.set(0,0,0),E=1,A.set(0,0,0)},this.reset=function(){d.pivot.copy(d.pivotReset),d.object.position.copy(d.positionReset),d.object.zoom=d.zoomReset,d.update(),h=p.NONE};var d=this,p={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},h=p.NONE,m=new THREE.Spherical,f=new THREE.Spherical,E=1,T=new THREE.Vector2,w=new THREE.Vector2,v=new THREE.Vector2,g=new THREE.Vector2,R=new THREE.Vector2,O=new THREE.Vector2,b=new THREE.Vector2,y=new THREE.Vector2,M=new THREE.Vector2,A=new THREE.Vector3,H=function(e,o){var n=new THREE.Vector3,a=new THREE.Vector3,r=new THREE.Vector3;n.copy(d.object.position).sub(d.pivot);var i=n.length();i*=Math.tan(d.object.fov/2*Math.PI/180),a.setFromMatrixColumn(d.object.matrix,0),r.setFromMatrixColumn(d.object.matrix,1),a.multiplyScalar(-2*e*i/t.clientHeight),r.multiplyScalar(2*o*i/t.clientHeight),A.add(a),A.add(r)};d.renderer.addEventListener("contextmenu",o,!1),d.renderer.addEventListener("mousedown",n,!1),d.renderer.addEventListener("wheel",i,!1),d.renderer.addEventListener("touchstart",s,!1),d.renderer.addEventListener("touchend",c,!1),d.renderer.addEventListener("touchmove",l,!1),window.addEventListener("keydown",u,!1),this.update()};var serverAddress="192.168.0.28",serverPort="8081";